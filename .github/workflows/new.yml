name: Build Linux Kernel (Custom Version)

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "Enter kernel version (e.g. 6.18.2 or 6.19-rc2). Must exist on kernel.org."
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          pacman -Syu --noconfirm base-devel git bc flex bison openssl libelf pahole wget tar xz curl

      - name: Check kernel source availability
        run: |
          VERSION=${{ github.event.inputs.kernel_version }}
          echo "Checking kernel version: $VERSION"
          wget --spider https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${VERSION}.tar.xz || exit 1

      - name: Download Linux source
        run: |
          VERSION=${{ github.event.inputs.kernel_version }}
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${VERSION}.tar.xz
          tar -xf linux-${VERSION}.tar.xz
          mv linux-${VERSION} linux
          cd linux
          make defconfig

      - name: Build kernel
        run: |
          cd linux
          make -j$(nproc)

      - name: Convert bzImage to .img
        run: |
          VERSION=${{ github.event.inputs.kernel_version }}
          cp linux/arch/x86/boot/bzImage linux-${VERSION}.img

      - name: Create Release and Upload bzImage & IMG
        uses: softprops/action-gh-release@v2
        with:
          tag_name: linux-${{ github.event.inputs.kernel_version }}
          name: "Linux Kernel ${{ github.event.inputs.kernel_version }}"
          body: "Automatically built Linux kernel version ${{ github.event.inputs.kernel_version }}."
          files: |
            linux/arch/x86/boot/bzImage
            linux-${{ github.event.inputs.kernel_version }}.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to 123 Cloud via WebDAV
        run: |
          VERSION=${{ github.event.inputs.kernel_version }}
          curl -u "${{ secrets.WEBDAV_USER }}:${{ secrets.WEBDAV_PASS }}" \
            -T linux/arch/x86/boot/bzImage \
            "https://webdav.123pan.cn/webdav/arch/linux-${VERSION}-bzImage"
          curl -u "${{ secrets.WEBDAV_USER }}:${{ secrets.WEBDAV_PASS }}" \
            -T linux-${VERSION}.img \
            "https://webdav.123pan.cn/webdav/arch/linux-${VERSION}.img"
